name: CI/CD Pipeline

on:
  push:
    branches: [main]

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: â¬‡ï¸ Checkout Code
      uses: actions/checkout@v3

    # ğŸ”§ Set up .NET for Backend
    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: ğŸ“¦ Restore Backend Dependencies
      run: dotnet restore ./backend/BandRecruitingApp.API

    - name: ğŸ› ï¸ Build Backend
      run: dotnet build ./backend/BandRecruitingApp.API --configuration Release

    - name: ğŸ§ª Run Backend Tests
      run: dotnet test ./backend/BandRecruitingApp.API --no-build --verbosity normal

    # ğŸŒ Set up Node.js for Angular Frontend
    - name: ğŸŒ Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: ğŸ“¦ Install Frontend Dependencies
      run: |
        cd frontend/band-recruiting-app
        npm ci

    - name: ğŸ—ï¸ Build Angular App
      run: |
        cd frontend/band-recruiting-app
        npm run build -- --configuration production

    # â˜ï¸ Deploy Frontend to S3
    - name: ğŸš€ Deploy Angular to S3
      uses: jakejarvis/s3-sync-action@master
      with:
        args: --acl public-read --delete
      env:
        AWS_S3_BUCKET: ${{ secrets.S3_BUCKET_NAME }}
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_REGION: ${{ secrets.AWS_REGION }}
        SOURCE_DIR: frontend/band-recruiting-app/dist/band-recruiting-app/

    # ğŸ§± CDK Deploy
    - name: ğŸ—ï¸ Install AWS CDK
      run: npm install -g aws-cdk

    - name: ğŸ› ï¸ Install CDK Dependencies
      run: |
        cd infrastructure/sandbox-cdk
        npm ci

    - name: ğŸš€ Deploy CDK Stack
      run: |
        cd infrastructure/sandbox-cdk
        cdk deploy --require-approval never
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_REGION: ${{ secrets.AWS_REGION }}
